<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DB Manager</title>
  <!-- Load sql-wasm.js from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { padding: 10px; margin: 5px; }
    table, th, td { border: 1px solid black; border-collapse: collapse; }
    th, td { padding: 8px; }
  </style>
</head>
<body>
  <h2>AI Product Inserter</h2>

  <input type="url" id="imageUrl" placeholder="Image URL" required>
  <input type="number" id="price" placeholder="Price (10-600)" min="10" max="600" required>
  <button onclick="addProduct()">‚ûï Add Product</button>
  <button onclick="showDB()">üìä Show Products</button>

  <div id="output">DB loading...</div>

  <script>
    let db, SQL;

    // Initialize SQL.js, tell it where to find wasm file on CDN
    initSqlJs({
      locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
    }).then(async SQLLib => {
      SQL = SQLLib;

      // Fetch your existing DB file if you have it, else create new
      try {
        const response = await fetch("ecommerce.db");
        if (response.ok) {
          const buffer = await response.arrayBuffer();
          db = new SQL.Database(new Uint8Array(buffer));
        } else {
          // If no DB file, create empty DB with products table
          db = new SQL.Database();
          db.run(`
            CREATE TABLE IF NOT EXISTS products (
              id INTEGER PRIMARY KEY,
              name TEXT,
              price INTEGER,
              picture_url TEXT,
              category TEXT
            );
          `);
        }
        document.getElementById('output').textContent = "‚úÖ DB Loaded";
      } catch (e) {
        document.getElementById('output').textContent = "‚ùå Failed to load DB: " + e.message;
      }
    });

    async function addProduct() {
      const url = document.getElementById("imageUrl").value.trim();
      const price = parseInt(document.getElementById("price").value);

      if (!url || price < 10 || price > 600) {
        alert("Enter a valid image URL and price between 10‚Äì600");
        return;
      }

      // Call your Netlify function to get AI-generated name & category
      try {
        const res = await fetch('/.netlify/functions/ai-helper', {
          method: 'POST',
          body: JSON.stringify({ imageUrl: url }),
          headers: { 'Content-Type': 'application/json' }
        });

        if (!res.ok) throw new Error('Failed to get AI data');

        const { name, category } = await res.json();

        // Get last id or 0 if none
        const resId = db.exec("SELECT MAX(id) AS id FROM products;");
        const lastId = (resId.length && resId[0].values[0][0]) || 0;
        const nextId = lastId + 1;

        db.run(`INSERT INTO products (id, name, price, picture_url, category) VALUES (?, ?, ?, ?, ?)`, [nextId, name, price, url, category]);
        alert("‚úÖ Product added!");
      } catch (error) {
        alert("Error adding product: " + error.message);
      }
    }

    function showDB() {
      if (!db) {
        document.getElementById('output').innerHTML = "DB not loaded yet.";
        return;
      }
      const res = db.exec("SELECT * FROM products");

      if (!res.length) {
        document.getElementById('output').innerHTML = "No products.";
        return;
      }

      const cols = res[0].columns;
      const rows = res[0].values;

      let html = "<table><tr>";
      cols.forEach(c => html += `<th>${c}</th>`);
      html += "</tr>";
      rows.forEach(r => {
        html += "<tr>" + r.map(val => `<td>${val}</td>`).join("") + "</tr>";
      });
      html += "</table>";

      document.getElementById('output').innerHTML = html;
    }
  </script>
</body>
</html>
