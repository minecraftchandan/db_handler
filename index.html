<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SQLite AI Web Manager</title>
  <script src="sql-wasm.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { padding: 10px; margin: 5px; }
    table, th, td { border: 1px solid black; border-collapse: collapse; }
    th, td { padding: 8px; }
  </style>
</head>
<body>
  <h2>AI Product Inserter</h2>

  <input type="url" id="imageUrl" placeholder="Image URL" required>
  <input type="number" id="price" placeholder="Price (10-600)" min="10" max="600" required>
  <button onclick="addProduct()">âž• Add Product with AI</button>
  <button onclick="showDB()">ðŸ“Š Show Products</button>

  <div id="output">DB loading...</div>

  <script>
    let db, SQL;

    initSqlJs({ locateFile: file => `sql-wasm.wasm` }).then(async SQLLib => {
      SQL = SQLLib;
      const response = await fetch("ecommerce.db");
      const buffer = await response.arrayBuffer();
      db = new SQL.Database(new Uint8Array(buffer));
      document.getElementById('output').textContent = "âœ… DB Loaded";
    });

    async function addProduct() {
      const url = document.getElementById("imageUrl").value;
      const price = parseInt(document.getElementById("price").value);

      if (!url || price < 10 || price > 600) {
        alert("Enter a valid image URL and price between 10â€“600");
        return;
      }

      const res = await fetch('/.netlify/functions/ai-helper', {
        method: 'POST',
        body: JSON.stringify({ imageUrl: url }),
        headers: { 'Content-Type': 'application/json' }
      });

      const { name, category } = await res.json();
      const lastId = db.exec("SELECT MAX(id) AS id FROM products;")[0].values[0][0] || 0;
      const nextId = lastId + 1;

      db.run(`INSERT INTO products (id, name, price, picture_url, category) VALUES (?, ?, ?, ?, ?)`, [nextId, name, price, url, category]);
      alert("âœ… Product added!");
    }

    function showDB() {
      const output = document.getElementById('output');
      const res = db.exec("SELECT * FROM products");

      if (!res.length) {
        output.innerHTML = "No products.";
        return;
      }

      const cols = res[0].columns;
      const rows = res[0].values;

      let html = "<table><tr>";
      cols.forEach(c => html += `<th>${c}</th>`);
      html += "</tr>";
      rows.forEach(r => {
        html += "<tr>" + r.map(val => `<td>${val}</td>`).join("") + "</tr>";
      });
      html += "</table>";

      output.innerHTML = html;
    }
  </script>
</body>
</html>